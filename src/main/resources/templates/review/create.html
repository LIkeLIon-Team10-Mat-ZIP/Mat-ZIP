<!DOCTYPE html>
<html layout:decorate="~{common/layout/defaultLayout.html}">
<head>
    <title>리뷰 등록</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        .rating .star {
            font-size: 2em;
        }

        .empty {
            color: #ccc;
        }
    </style>
</head>
<body>

<main layout:fragment="Content">
    <script>
        function CreateReview__submit(form) {
            // content 이(가) 올바른지 체크
            form.content.value = form.content.value.trim();

            if (form.content.value.length === 0) {
                toastWarning('내용을 입력해주세요.');
                form.content.focus();
                return;
            }

            form.submit(); // 폼 발송
        }
    </script>
    <h1>리뷰 작성</h1>
    <p>맛집 정보:</p>
    <p>맛집 이름: <span id="matzipName"></span></p>
    <p>맛집 주소: <span id="address"></span></p>
    <p>전화번호: <span id="phoneNumber"></span></p>
    <p>평점: <span id="rating" class="rating"></span></p>
    div class="min-h-screen flex items-center justify-center mt-[-70px] w-full">
    <form th:action="@{/review/create}" th:object="${reviewCreationDTO}" method="post" style="width: 650px" onsubmit="CreateReview__submit(this); return false;">
        <input type="hidden" name="author" th:value="${author}">
        <div class="flex flex-col mb-8">
            <span class="text-3xl mb-10"><i class="fa-solid fa-pencil"></i> Review</span>
            <span class="mb-2 text-lg"><i class="fa-solid fa-ranking-star"></i> 별점</span>
            <div class="rating rating-md rating-half">
                <input type="radio" name="rating" value="0.5" class="bg-yellow-500 mask mask-star-2 mask-half-1"
                       checked/>
                <input type="radio" name="rating" value="1.0" class="bg-yellow-500 mask mask-star-2 mask-half-2"/>
                <input type="radio" name="rating" value="1.5" class="bg-yellow-500 mask mask-star-2 mask-half-1"/>
                <input type="radio" name="rating" value="2.0" class="bg-yellow-500 mask mask-star-2 mask-half-2"/>
                <input type="radio" name="rating" value="2.5" class="bg-yellow-500 mask mask-star-2 mask-half-1"/>
                <input type="radio" name="rating" value="3.0" class="bg-yellow-500 mask mask-star-2 mask-half-2"/>
                <input type="radio" name="rating" value="3.5" class="bg-yellow-500 mask mask-star-2 mask-half-1"/>
                <input type="radio" name="rating" value="4.0" class="bg-yellow-500 mask mask-star-2 mask-half-2"/>
                <input type="radio" name="rating" value="4.5" class="bg-yellow-500 mask mask-star-2 mask-half-1"/>
                <input type="radio" name="rating" value="5.0" class="bg-yellow-500 mask mask-star-2 mask-half-2"/>
            </div>
        </div>
        <div class="mb-5 flex flex-col">
            <span class="mb-2 text-lg"><i class="fa-solid fa-camera"></i> 이미지 등록</span>
            <input type="file" class="file-input file-input-bordered file-input-error w-full max-w-3xl"/>
        </div>
        <div>
            <div>
                <span class="text-lg"><i class="fa-solid fa-comments"></i> 내용</span>
                <label>
                        <textarea class="textarea textarea-error textarea-lg w-full max-w-3xl" rows="7" name="content"
                        ></textarea>
                </label>
            </div>
            <button class="btn btn-outline btn-error btn-sm" type="button" onclick="fff()">hihihi</button>

            <div class="flex justify-end">
                <button class="btn btn-outline btn-error btn-sm">Submit</button>
            </div>
        </div>
    </form>
    </div>
    <form th:action="@{/review/create}" th:object="${reviewCreationDTO}" method="post">
        <input type="hidden" name="author" th:value="${author}">
        <div class="rating">
            <input type="radio" name="rating" value="1" class="mask mask-star-2 bg-orange-400"/>
            <input type="radio" name="rating" value="2" class="mask mask-star-2 bg-orange-400" checked/>
            <input type="radio" name="rating" value="3" class="mask mask-star-2 bg-orange-400"/>
            <input type="radio" name="rating" value="4" class="mask mask-star-2 bg-orange-400"/>
            <input type="radio" name="rating" value="5" class="mask mask-star-2 bg-orange-400"/>
        </div>

        <div>
            <label>내용:</label>
            <input class="textarea textarea-bordered textarea-lg w-full max-w-xs" type="text" name="content" required/>
        </div>

        <div>
            <button class="btn btn-outline" type="submit">Submit</button>
        </div>
    </form>
    <!-- 리뷰 작성 폼 -->
    <form id="reviewForm" action="/matzip/createWithReview" method="POST">
        <!-- 맛집 정보를 히든 필드로 전달 -->
        <input type="hidden" name="matzipName" id="matzipNameInput">
        <input type="hidden" name="address" id="addressInput">
        <input type="hidden" name="phoneNumber" id="phoneNumberInput">
        <input type="hidden" name="rating" id="ratingInput">
        <input type="hidden" name="matzipType" id="matzipTypeInput">
        <label for="reviewContent">리뷰 내용:</label>
        <textarea id="reviewContent" name="reviewContent"></textarea>

        <input type="submit" value="리뷰 작성">
    </form>
</main>
<script>
    // 세션 스토리지에서 저장된 맛집 정보를 가져옵니다
    var matzipCreationDTOString = sessionStorage.getItem('matzipCreationDTO');
    var matzipCreationDTO = JSON.parse(matzipCreationDTOString);

    // 맛집 정보를 화면에 표시합니다
    document.getElementById('matzipName').textContent = matzipCreationDTO.matzipName;
    document.getElementById('address').textContent = matzipCreationDTO.address;
    document.getElementById('phoneNumber').textContent = matzipCreationDTO.phoneNumber;

    // 평점을 별로 표시합니다
    var rating = parseInt(matzipCreationDTO.rating);
    var ratingContainer = document.getElementById('rating');
    for (var i = 1; i <= rating; i++) {
        var star = document.createElement('span');
        star.textContent = '⭐';
        star.classList.add('star');
        star.setAttribute('data-rating', i);
        ratingContainer.appendChild(star);
    }

    // 별점 클릭 이벤트 핸들러
    var stars = document.getElementsByClassName('star');
    for (var j = 0; j < stars.length; j++) {
        stars[j].addEventListener('click', function () {
            var selectedRating = this.getAttribute('data-rating');
            matzipCreationDTO.rating = selectedRating; // 평점 업데이트
            document.getElementById('ratingInput').value = selectedRating;
            updateRatingDisplay();
        });
    }

    // 평점 표시 업데이트 함수
    function updateRatingDisplay() {
        var currentRating = parseInt(matzipCreationDTO.rating);
        var stars = document.getElementsByClassName('star');
        for (var k = 0; k < stars.length; k++) {
            var starRating = stars[k].getAttribute('data-rating');
            if (starRating <= currentRating) {
                stars[k].classList.remove('empty');
            } else {
                stars[k].classList.add('empty');
            }
        }
    }

    // 초기 별점 표시 업데이트
    updateRatingDisplay();

    // 맛집 정보를 히든 필드에 설정합니다
    document.getElementById('matzipNameInput').value = matzipCreationDTO.matzipName;
    document.getElementById('addressInput').value = matzipCreationDTO.address;
    document.getElementById('phoneNumberInput').value = matzipCreationDTO.phoneNumber;
    document.getElementById('ratingInput').value = matzipCreationDTO.rating;
    document.getElementById('matzipTypeInput').value = matzipCreationDTO.matzipType;

    // 리뷰 작성 폼 제출 시 처리할 함수
    document.getElementById('reviewForm').addEventListener('submit', function (event) {
        event.preventDefault(); // 기본 동작인 폼 제출을 막습니다
        // 서버로 맛집 정보를 전송합니다
        // CSRF 토큰을 가져옵니다
        var csrfToken = document.querySelector('meta[name=_csrf]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name=_csrf_header]').getAttribute('content');


        // 서버로 리뷰 작성 폼을 제출합니다
        fetch('/matzip/createWithReview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken  // CSRF 토큰을 헤더에 포함합니다
            },
            body: JSON.stringify({
                matzipCreationDTO: matzipCreationDTO,
                reviewCreationDTO: {
                    content: document.getElementById('reviewContent').value,
                    rating: rating
                }
            })
        })
            .then(response => {
                if (response.ok) {
                    alert('맛집 등록과 리뷰가 작성되었습니다!');
                    window.location.href = '/matzip/list';
                } else {
                    alert('리뷰 작성에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('리뷰 작성에 실패했습니다.');
            });
    });
</script>

</body>

</html>